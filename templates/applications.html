{% extends 'base.html' %} 
{% block title %} QS University - Applications {% endblock %} 
{% block content %}
<style>
    /* Your existing styles */
</style>
<h1>Applications</h1>

<div class="container-fluid">
    <div class="row">
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="submittedAtStart" class="form-label">Submitted At (Start)</label>
                <input type="date" id="submittedAtStart" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="submittedAtEnd" class="form-label">Submitted At (End)</label>
                <input type="date" id="submittedAtEnd" class="form-control">
            </div>
            <div class="col-md-2 align-self-end">
                <button id="filterDateRange" class="btn btn-primary w-100">Filter</button>
            </div>
        </div>
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Applications Overview</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="applicationsTable" class="table table-striped table-bordered table-hover" style="width:100%">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>User</th>
                                    <th>Submitted At</th>
                                    <th>Created At</th>
                                    <th>Updated At</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        console.log('Applications page loaded');
        
        var table = $('#applicationsTable').DataTable({
            ajax: {
                url: 'http://localhost:8000/api/applications',
                method: 'GET',
                dataSrc: 'results'
            },
            columns: [
                { data: 'id' },
                { data: 'name' },
                { data: 'description' },
                { data: 'user' },
                { 
                    data: 'submitted_at', 
                    render: function(data) {
                        // This render function formats the data for display in the table.
                        // It's producing "DD/MM/YYYY" like "03/07/2025".
                        return new Date(data).toLocaleDateString(); 
                    }
                },
                { 
                    data: 'created_at',
                    render: function(data) {
                        return new Date(data).toLocaleDateString();
                    }
                },
                { 
                    data: 'updated_at',
                    render: function(data) {
                        return new Date(data).toLocaleDateString();
                    }
                }
            ]
        });

        // Helper function to parse DD/MM/YYYY date strings reliably
        function parseDateDDMMYYYY(dateString) {
            if (!dateString) {
                return null;
            }
            // Split the string by '/'
            const parts = dateString.split('/');
            // Check if it has 3 parts (day, month, year)
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed in Date constructor
                const year = parseInt(parts[2], 10);
                
                // Create a new Date object (year, month, day)
                // This ensures it's parsed as DD/MM/YYYY
                const date = new Date(year, month, day);

                // Optional: Validate the date to prevent issues with invalid dates like 31/02/2025
                if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                    return date;
                }
            }
            return null; // Return null for invalid or unparseable strings
        }

        // Custom filtering function for date range
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                if (settings.nTable.id !== 'applicationsTable') {
                    return true; 
                }

                var startDateStr = $('#submittedAtStart').val(); // YYYY-MM-DD from input type="date"
                var endDateStr = $('#submittedAtEnd').val();   // YYYY-MM-DD from input type="date"
                
                // Get the raw data for 'submitted_at'. 
                // Based on your console output, this is coming as "DD/MM/YYYY" string.
                var submittedDateRaw = data[4]; 

                // Parse the submittedDateRaw string using our custom helper
                var rowDate = parseDateDDMMYYYY(submittedDateRaw);

                // Convert filter dates to Date objects (YYYY-MM-DD from input type="date" is fine for new Date())
                var minDate = startDateStr ? new Date(startDateStr) : null;
                var maxDate = endDateStr ? new Date(endDateStr) : null;
                
                // Check for invalid dates (important for debugging parsing issues)
                if (rowDate === null || isNaN(rowDate.getTime())) {
                    console.error("Error: Could not parse submittedDateRaw into a valid Date object for row index", dataIndex, "Value:", submittedDateRaw);
                    return false; // Exclude rows with unparseable dates from results
                }

                // For accurate range comparisons, set times to start/end of the day
                if (minDate) {
                    minDate.setHours(0, 0, 0, 0);
                }
                if (maxDate) {
                    maxDate.setHours(23, 59, 59, 999);
                }

                // // Log values for debugging
                // console.log(
                //     'Filter Evaluation - Row Index:', dataIndex,
                //     'Start Filter (ISO):', minDate ? minDate.toISOString() : 'N/A',
                //     'End Filter (ISO):', maxDate ? maxDate.toISOString() : 'N/A',
                //     'Row Submitted At (Raw from data[4]):', submittedDateRaw,
                //     'Row Submitted At (Parsed and Corrected):', rowDate ? rowDate.toISOString() : 'N/A',
                //     'Result:', (minDate === null || rowDate >= minDate) && (maxDate === null || rowDate <= maxDate)
                // );


                // Logic for filtering
                if (minDate === null && maxDate === null) {
                    return true; // No date range selected, show all
                }
                
                // If rowDate is null (e.g., missing data or failed parsing), it cannot be matched within a range
                if (rowDate === null) {
                    return false;
                }

                // Check if rowDate is within the range
                var isWithinRange = true;
                if (minDate !== null && rowDate < minDate) {
                    isWithinRange = false;
                }
                if (maxDate !== null && rowDate > maxDate) {
                    isWithinRange = false;
                }
                
                return isWithinRange;
            }
        );

        $('#filterDateRange').on('click', function() {
            table.draw();
        });

        $('#submittedAtStart, #submittedAtEnd').on('change', function() {
            table.draw(); 
        });
    });
</script>

{% endblock %}